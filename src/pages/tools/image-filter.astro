---
import BaseLayout from '../../layouts/BaseLayout.astro';
---
<BaseLayout title="Image Filter" description="อัพโหลดรูปและใช้ filter — blur, edge, grayscale, sepia">
  <h1>Image Filter</h1>
  <p class="intro">อัพโหลดรูปแล้วเลือก filter การประมวลผลทำที่ edge (Cloudflare) ด้วย Photon WASM</p>

  <div class="tool-panel">
    <div class="upload-area">
      <label for="file">เลือกรูปภาพ (JPEG/PNG)</label>
      <input type="file" id="file" accept="image/jpeg,image/png,image/webp" />
      <div id="preview" class="preview" aria-live="polite"></div>
    </div>
    <div class="controls">
      <label for="filter">Filter</label>
      <select id="filter">
        <option value="none">ไม่มี</option>
        <option value="grayscale">Grayscale</option>
        <option value="sepia">Sepia</option>
        <option value="blur">Blur</option>
        <option value="edge">Edge detection</option>
      </select>
      <button type="button" id="apply" disabled>ประมวลผล</button>
    </div>
    <div id="result-area" class="result-area" hidden>
      <h2>ผลลัพธ์</h2>
      <img id="result-img" alt="ผลลัพธ์หลังใช้ filter" />
      <a id="download" href="#" download="filtered.png" class="btn-dl">ดาวน์โหลด</a>
    </div>
    <div id="error" class="error" role="alert" hidden></div>
  </div>
</BaseLayout>

<style>
  .intro { color: var(--muted); margin-bottom: 1.5rem; }
  .tool-panel { background: var(--surface); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.06); }
  .upload-area label, .controls label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; }
  .upload-area input[type="file"] { margin-bottom: 1rem; }
  .preview { min-height: 80px; margin-top: 0.5rem; }
  .preview img { max-width: 100%; max-height: 240px; border-radius: 8px; }
  .controls { margin: 1rem 0; display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
  .controls select { padding: 0.5rem; border-radius: 6px; background: var(--bg); border: 1px solid rgba(255,255,255,0.15); color: inherit; }
  .controls button { padding: 0.5rem 1rem; background: var(--accent); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
  .controls button:hover:not(:disabled) { background: var(--accent-hover); }
  .controls button:disabled { opacity: 0.5; cursor: not-allowed; }
  .result-area { margin-top: 1.5rem; }
  .result-area h2 { font-size: 1.1rem; margin-bottom: 0.5rem; }
  .result-area img { max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin-bottom: 0.5rem; }
  .btn-dl { display: inline-block; padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--accent); border-radius: 6px; }
  .error { color: #f87171; margin-top: 1rem; }
</style>

<script>
  const fileInput = document.getElementById('file') as HTMLInputElement;
  const filterSelect = document.getElementById('filter') as HTMLSelectElement;
  const applyBtn = document.getElementById('apply') as HTMLButtonElement;
  const preview = document.getElementById('preview')!;
  const resultArea = document.getElementById('result-area')!;
  const resultImg = document.getElementById('result-img') as HTMLImageElement;
  const downloadLink = document.getElementById('download') as HTMLAnchorElement;
  const errorEl = document.getElementById('error')!;

  fileInput?.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    preview.innerHTML = '';
    resultArea.hidden = true;
    errorEl.hidden = true;
    if (!file) {
      applyBtn.disabled = true;
      return;
    }
    const url = URL.createObjectURL(file);
    const img = document.createElement('img');
    img.src = url;
    img.alt = 'รูปที่เลือก';
    preview.appendChild(img);
    applyBtn.disabled = false;
  });

  applyBtn?.addEventListener('click', async () => {
    const file = fileInput.files?.[0];
    const filter = filterSelect?.value || 'none';
    if (!file || filter === 'none') return;
    errorEl.hidden = true;
    applyBtn.disabled = true;
    applyBtn.textContent = 'กำลังประมวลผล...';
    try {
      const form = new FormData();
      form.append('image', file);
      form.append('filter', filter);
      const res = await fetch('/api/filter', { method: 'POST', body: form });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || `Error ${res.status}`);
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      resultImg.src = url;
      downloadLink.href = url;
      downloadLink.download = `filtered-${filter}.png`;
      resultArea.hidden = false;
    } catch (e) {
      errorEl.textContent = e instanceof Error ? e.message : 'เกิดข้อผิดพลาด';
      errorEl.hidden = false;
    } finally {
      applyBtn.disabled = false;
      applyBtn.textContent = 'ประมวลผล';
    }
  });
</script>
